{% extends "base.html" %}

{% block content %}
    <div class="main-panel">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <div class="navbar-toggle">
              <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </button>
            </div>
            <a class="navbar-brand" href="#pablo">Building Management</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navigation">
            <form action="" method="post">

              <div class="input-group no-border">
                <input type="text" value="" class="form-control" placeholder="Search...">
                <div class="input-group-append">
                  <div class="input-group-text">
                    <i class="nc-icon nc-zoom-split"></i>
                  </div>
      
                </div>
              </div>
            </form>
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link btn-rotate">
                  <i class="nc-icon nc-settings-gear-65"></i>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link btn-rotate" href="{{url_for('logout')}}">
                  <i class="fa fa-sign-out"></i>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Content -->
      <div class="content">
          <div class="row">
              <div class="col-md-7">
                <!-- Top card in which you provide the building location information -->
                  <div class="card">
                      <!-- Card header of the top one -->
                      <div class="card-header ">
                          <h5 class="card-title mb-0">Building Adress</h5>
                          <div class="card-category" style="text-transform:none">Provide the address of the location you want to estimate</div>
                        </div>            

                    <div class="card-body">

                      <!-- First row: Postalcode & House Number -->
                      <div class="row" style="margin-top:0px">
                        <div class="p-2 col-md-3" style="background-color: #e3e3e3; ; color: #66615B">Postal Code</div>
                        {{ BuildingManagementForm.postalcode(class="p-1 bg-light text-dark rounded col-md-4", onchange="postalcodeChanged()" )  }}
                        <div class="p-2 col-md-3" style="background-color: #e3e3e3; ; color: #66615B">House Number</div>
                        {{ BuildingManagementForm.housenumber(class="p-1 bg-light text-dark rounded col-md-2", onchange="housenumberChanged()")  }}       
                      </div>

                      <!-- Second row: Street Name -->
                      <div class="row" style="margin-top:15px">
                        <div class="p-2 col-md-3 rounded " style="background-color: #e3e3e3; color: #66615B">Street Name</div>
                        {{ BuildingManagementForm.streetname(class="p-1 bg-light text-dark rounded col-md-9") }}
                      </div>

                      <!-- Third row: City -->
                      <div class="row" style="margin-top:15px">
                        <div class="p-2 col-md-3" style="background-color: #e3e3e3; ; color: #66615B">City</div>
                        {{ BuildingManagementForm.city(class="p-1 bg-light text-dark rounded col-md-9")  }}    
                      </div>
                            
                    </div>

                  </div>
              </div>
              <!-- Google maps -->
              <div class="col-md-5">
                  <iframe src="https://www.google.com/maps/embed" width="100%" height="90%" frameborder="0" id="googleMapsTop" style="border:0; margin-bottom: 20px" allowfullscreen></iframe>
              </div>
          </div>
        </div>
    </div>

    <script>
      function isValidPostalCode(postcalCode) {

        var postalCode = String(postalCode)
        // Check if the postalcode is valid.
        // Check if length is 6, first 4 characters are numbers and last 2 are digits.
        if (postalCode.length == 6 || /^\d+$/.test(postalCode.substring(0,4)) || /^[a-zA-Z]+$/.test(postalCode.substring(4,6)) ) {
          
          return true
        }
        else {
          return false
        }
      }

      function postalcodeChanged() {
        postcalCodeField = document.getElementById("postalcode")

        // Check if a valid postal code is provided
        if (! isValidPostalCode(postcalCodeField.value) ) {
            // Show that it is an invalid postal code

            // break out of function
            return
        }

        var request = new XMLHttpRequest()

        request.open('GET', 'http://geodata.nationaalgeoregister.nl/locatieserver/free?rows=1&&fq=postcode:' + postcalCodeField.value);
        request.send()

        request.onload=function(){
          if(this.readyState == 4 && this.status==200){
            var data = JSON.parse(this.response);

            var response = data["response"]

            // Check if this postalcode actually does exist.
            if (response["numFound"] == 0) {
                return
            } else {
                document.getElementById("city").value = response["docs"]["0"]["woonplaatsnaam"]
              }
          }
        }
      }

      function housenumberChanged(){
        // Get the value in the street name field
        housenumberField = document.getElementById("housenumber")

        // Get the value of the postal code field
        postcalCodeField = document.getElementById("postalcode")

        // Check if a postal code has been provided by the user.
        if (postcalCodeField.value == "") {
          return
        }
        var request = new XMLHttpRequest()

        request.open('GET', 'http://geodata.nationaalgeoregister.nl/locatieserver/free?rows=1&&fq=postcode:' + postcalCodeField.value + '&&fq=huisnummer:' + housenumberField.value);
        request.send()
        request.onload=function(){
          if(this.readyState == 4 && this.status==200){
            var data = JSON.parse(this.response);

            var response = data["response"]

            // Check if this postalcode actually does exist.
            if (response["numFound"] == 0) {
                return
            } else {
                cordinates = response["docs"]["0"]["centroide_ll"]
                x_cordinate = cordinates.substring(cordinates.lastIndexOf(' ')+ 1 , cordinates.lastIndexOf(')'))
                y_cordinate = cordinates.substring(cordinates.lastIndexOf('(')+ 1 , cordinates.lastIndexOf(' '))
                document.getElementById("streetname").value = response["docs"]["0"]["straatnaam"]
                document.getElementById("city").value =  response["docs"]["0"]["woonplaatsnaam"]
              
                document.getElementById("googleMapsTop").src="http://maps.google.com/maps?q=loc:" + 
                                                              x_cordinate + ',' + y_cordinate +
                                                              "&z=15&output=embed&iwd=-1";
              }
          }
        }
      }
    </script>

      {% endblock %}